-- INITIAL SELECT WITH IMPORTANT DATA FROM 2023 SURVEY

DESCRIBE STACKOVERFLOW.SO_2023;

SELECT RESPONSEID, AGE, EDLEVEL, LEARNCODE, YEARSCODE, COUNTRY 
FROM STACKOVERFLOW.SO_2023 
WHERE LEARNCODE IN ('Books / Physical media', 'Coding Bootcamp', 'Other online resources (e.g., videos, blogs, forum)', 'School (i.e., University, College, etc)');


-- INITIAL SELECT WITH IMPORTANT DATA FROM 2022 SURVEY

DESCRIBE STACKOVERFLOW.SO_2022;

SELECT RESPONSEID, AGE, EDLEVEL, LEARNCODE, YEARSCODE, COUNTRY 
FROM STACKOVERFLOW.SO_2022
WHERE LEARNCODE IN ('Books / Physical media', 'Coding Bootcamp', 'Other online resources (e.g., videos, blogs, forum)', 'School (i.e., University, College, etc)');


-- CREATING TABLES

CREATE TABLE SOuser (
    userId INT,
    age INT,
    country VARCHAR(255),
    edlevel VARCHAR(255),
    yearscode INT,
    CONSTRAINT pk_SOuser PRIMARY KEY(userId)
);

CREATE TABLE learncode (
    resourceType VARCHAR(255),
    SOuserId INT,
    CONSTRAINT pk_learncode PRIMARY KEY (resourceType, SOuserId),
    CONSTRAINT fk_SOuserId FOREIGN KEY (SOuserId) REFERENCES SOuser(userId)
);


-- User-defined function to split string
CREATE OR REPLACE FUNCTION SPLIT_STRING(str VARCHAR2, delim VARCHAR2, pos PLS_INTEGER)
RETURN VARCHAR2 IS
  i PLS_INTEGER;
BEGIN
  WHILE pos > 0 LOOP
    pos := INSTR(str, delim, 1, pos);
    i := i + 1;
  END LOOP;
  RETURN SUBSTR(str, INSTR(str, delim, 1, i) + 1,
                INSTR(str, delim, 1, i + 1) - INSTR(str, delim, 1, i) -1);
END;
/

-- Insert data into learncode
INSERT INTO learncode (resource, user)
SELECT resource, CONCAT('2023', responseId)
FROM (
  SELECT SPLIT_STRING(learncode, ';', LEVEL) AS resource, responseId
  FROM STACKOVERFLOW.SO_2023
  CONNECT BY LEVEL <= LENGTH(REGEXP_REPLACE(learncode, '[^;]+')) + 1
)
WHERE resource IN ('Books / Physical media', 'Coding Bootcamp', 'Other online resources (e.g., videos, blogs, forum)', 'School (i.e., University, College, etc)');

