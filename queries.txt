-- INITIAL SELECT WITH IMPORTANT DATA FROM 2023 SURVEY

DESCRIBE STACKOVERFLOW.SO_2023;

SELECT RESPONSEID, AGE, EDLEVEL, LEARNCODE, YEARSCODE, COUNTRY 
FROM STACKOVERFLOW.SO_2023 
WHERE LEARNCODE IN ('Books / Physical media', 'Coding Bootcamp', 'Other online resources (e.g., videos, blogs, forum)', 'School (i.e., University, College, etc)');

-- IMPORTANT SELECT FILTER FROM SURVEY

DESCRIBE STACKOVERFLOW.SO_2023;
SELECT * FROM STACKOVERFLOW.SO_2023 WHERE learncode IN ('Books / Physical media', 
'Coding Bootcamp', 'Other online resources (e.g., videos, blogs, forum)', 
'School (i.e., University, College, etc)');

-- INITIAL SELECT WITH IMPORTANT DATA FROM 2022 SURVEY

DESCRIBE STACKOVERFLOW.SO_2022;

SELECT RESPONSEID, AGE, EDLEVEL, LEARNCODE, YEARSCODE, COUNTRY 
FROM STACKOVERFLOW.SO_2022
WHERE LEARNCODE IN ('Books / Physical media', 'Coding Bootcamp', 'Other online resources (e.g., videos, blogs, forum)', 'School (i.e., University, College, etc)');


-- CREATING TABLES

CREATE TABLE SOuser (
    userId INT,
    age INT,
    country VARCHAR(255),
    edlevel VARCHAR(255),
    yearscode INT,
    CONSTRAINT pk_SOuser PRIMARY KEY(userId)
);

CREATE TABLE learncode (
    resourceType VARCHAR(255),
    SOuserId INT,
    CONSTRAINT pk_learncode PRIMARY KEY (resourceType, SOuserId),
    CONSTRAINT fk_SOuserId FOREIGN KEY (SOuserId) REFERENCES SOuser(userId)
);


-- function to split string
CREATE OR REPLACE FUNCTION SPLIT_STRING(str VARCHAR2, delim VARCHAR2, pos PLS_INTEGER)
RETURN VARCHAR2 IS
  i PLS_INTEGER;
  pos_temp PLS_INTEGER := pos;
BEGIN
  WHILE pos_temp > 0 LOOP
    pos_temp := INSTR(str, delim, 1, pos_temp);
    i := i + 1;
  END LOOP;
  RETURN SUBSTR(str, INSTR(str, delim, 1, i) + 1,
    INSTR(str, delim, 1, i + 1) - INSTR(str, delim, 1, i) -1);
END;
/

-- Insert data into learncode
INSERT ALL
      INTO LEARNCODE (resourcetype, SOuserId) VALUES (resourceType, CONCAT('2023', responseId))
      INTO SOUSER (userId, age, country, edlevel, yearscode) VALUES (CONCAT('2023', responseId), age, country, edlevel, yearscode)
SELECT resourceType, responseId, age, country, edlevel, yearscode
FROM (
      SELECT SPLIT_STRING(learncode, ';', LEVEL) AS resourceType, responseId, age, country, edlevel, yearscode
      FROM STACKOVERFLOW.SO_2023
      CONNECT BY LEVEL <= LENGTH(REGEXP_REPLACE(learncode, '[^;]+')) + 1
)
WHERE resourceType IN ('Books / Physical media', 
'Coding Bootcamp', 'Other online resources (e.g., videos, blogs, forum)', 
'School (i.e., University, College, etc)');

            
